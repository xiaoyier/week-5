**总结限流，熔断，降级的常用方式，重试的注意事项，负载均衡的常用方式。**


####  限流
限流是指在一段时间内，定义某个客户或应用可以接收或处理多少个请求的技术。

##### 单机限流
单个机器上限制流量，比如漏铜，令牌桶  
**优点:** 实现简单，稳定可靠，性能高  
**缺点:** 手动配额，运维成本高，程序变化，机器扩缩容等需要手动调整，容易出错；流量不均匀容易引发误限制

##### 动态流控
根据机器的负载情况等，动态限制流量，如BBR限流  
**优点:** 根据服务情况，动态限流，不需调整额度  
**缺点:** 需要主动搜集性能数据(cpu load, qps, latency等)；客户端主动善意限流；应用场景狭窄，一般只限于接口调用

##### 全局限流
通过配置全局额度，单节点获取额度，达到分布式限流的目的  
**优点:** 流量不均匀不会误触发限流；机器数变化无需手动调整额度；应用场景丰富  
**缺点:** 实现较复杂，需要手动配额

#### 熔断
当服务端触发限流，回复请求仍需一定资源开销，仍有可能让机器过载，此时需要在客户端进行熔断，不再向过载的机器发送请求

##### 断路器模式(例如Sentinel,Hystrix)

- 最开始处于closed状态，一旦检测到错误到达一定阈值，便转为open状态；
- 到达 reset timeout，会转移到half open状态；
- 尝试放行一部分请求到后端，一旦检测成功便回归到closed状态，即恢复服务；

#### 降级
通过降级回复来减少工作量，或者丢弃不重要的请求。从而提高服务可用性

##### 开关降级
通过配置开关，在大流量到来时打开开关，程序获取到配置后进行降级处理

##### 手动降级
- 页面降级、延迟服务、写/读降级、缓存降级
- 抛异常、返回约定协议、Mock 数据、Fallback 处理

#### 重试
- 限制重试次数，控制重试比率(比如控制重试请求占当前总请求的10%)
- 控制重试间隔时间，比如随机化，指数型递增周期
- client 记录重试次数，比如在请求metadata里带上当前重试次数，交由server判断是否拒绝
- **切记，只应在失败的这层进行重试**，防止重试风暴

#### 负载均衡
- 均衡的流量分发。
- 可靠的识别异常节点。
- scale-out，增加同质节点扩容。
- 减少错误，提高可用性。

静态负载均衡算法： 轮询，随机，比率，优先权
动态负载均衡算法: 最少连接数、最快响应速度、观察方法、预测法、动态性能分配、动态服务器补充、服务质量、服务类型、规则模式
    
##### p2c 算法 (随机选取2节点进行打分)
- 选择 backend：CPU，client：health、inflight、latency 作为指标，使用一个简单的线性方程进行打分。
- 对新启动的节点使用常量惩罚值（penalty），以及使用探针方式最小化放量，进行预热。
- 打分比较低的节点，避免进入“永久黑名单”而无法恢复，使用统计衰减的方式，让节点指标逐渐恢复到初始状态(即默认值)。
- 当前发出去的请求超过了 predict lagtency，就会加惩罚。

